<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <!-- <link href="https://fonts.googleapis.com/css?family=Roboto|Inconsolata|Work+Sans|Droid+Serif" rel="stylesheet"> -->
    <style>@font-face{font-family:'DroidSerif';font-style:normal;font-weight:400;src:local('DroidSerifRegular'),local('DroidSerif-Regular'),url(https://fonts.gstatic.com/s/droidserif/v8/tDbI2oqRg1oM3QBjjcaDkOr9rAA.ttf)format('truetype');}@font-face{font-family:'Inconsolata';font-style:normal;font-weight:400;src:local('InconsolataRegular'),local('Inconsolata-Regular'),url(https://fonts.gstatic.com/s/inconsolata/v16/QldKNThLqRwH-OJ1UHjlKGlZ5q0.ttf)format('truetype');}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;src:local('Roboto'),local('Roboto-Regular'),url(https://fonts.gstatic.com/s/roboto/v18/KFOmCnqEu92Fr1Mu4mxP.ttf)format('truetype');}@font-face{font-family:'WorkSans';font-style:normal;font-weight:400;src:local('WorkSans'),local('WorkSans-Regular'),url(https://fonts.gstatic.com/s/worksans/v3/QGYsz_wNahGAdqQ43Rh_fKDs.ttf)format('truetype');}</style>
    <!-- <link href="/css/text.css" rel="stylesheet" type="text/css"> -->
    <style>#header h1 { font-size: 120%; display: inline-block; } .sourceCode { overflow-x: scroll; } code, pre { color: #000; background-color: #fff; font-weight: normal; font-family: "Menlo", "Consolas", "Inconsolata", "Anonymous", "Monaco", monospace; font-size: 0.9em; line-height: 1.2em; } p code, li>code { border: 1px solid #DDDDDD; padding: 2px; font-size: 0.8em; } #header h1 a, h2.post-title a, h2.static-title a { color: #000; } ul, ol { margin-left: 2em; } div.highlight, pre { margin-bottom: 1em; } code.has-jax { border: none; background-color: #fff; } .date { font-style: italic; color: #4e4e4e; } body { font: 300 1.1em/1.6em Georgia, "Droid Serif", "Open Sans", "DejaVu Serif", serif; } blockquote { padding-top: 0; } .panel { padding-left: 2em; padding-right: 2em; font-size: 120%; } .panel p { font-weight: bold; font-style: italic; line-height: 1.1em; } footer { text-align: center; } footer span { font-style: italic; } footer { padding-top: 2em; } /* Generated by pandoc. */ table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode, table.sourceCode pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; border: none; } td.lineNumbers { border-right: 1px solid #AAAAAA; text-align: right; color: #AAAAAA; padding-right: 5px; padding-left: 5px; } td.sourceCode { padding-left: 5px; } .sourceCode span.kw { color: #007020; font-weight: bold; } .sourceCode span.dt { color: #902000; } .sourceCode span.dv { color: #40a070; } .sourceCode span.bn { color: #40a070; } .sourceCode span.fl { color: #40a070; } .sourceCode span.ch { color: #4070a0; } .sourceCode span.st { color: #4070a0; } .sourceCode span.co { color: #60a0b0; font-style: italic; } .sourceCode span.ot { color: #007020; } .sourceCode span.al { color: red; font-weight: bold; } .sourceCode span.fu { color: #06287e; } .sourceCode span.re { } .sourceCode span.er { color: red; font-weight: bold; }</style>
    <!-- <link href="/css/aduffy.css" rel="stylesheet" type="text/css"> -->
    <style>/* Modify selection color on WebKit/Mozilla. */ ::-moz-selection { background: antiquewhite; } ::selection { background: antiquewhite; } body { padding-bottom: 30px; }</style>
    
    <title>Unpacking C++ Templates • aduffy.io</title>
    
  </head>
  <body>
    <div class="row">
        <div id="header" class="large-10 large-offset-1 columns">
            <h1><a href="../">aduffy.io</a>://</h1>
            <a href="../">posts</a>
            /
            <a href="../about.html">about</a>
            /
            <a href="../projects.html">projects</a>
            /
            <a href="../photos.html">photos</a>
            &mdash;
            <span><a class="underline" href="https://github.com/a10y/a10y.github.io/commit/5fb2127
">5fb2127
</a></span>
        </div>
    </div>
    <div class="row">
      <div class="large-10 large-centered columns">
        
        <h1>Unpacking C++ Templates</h1>
        
        <p class="date">21 Oct 2016</p>

<p>For those of you that know me, I have a bit of an interest in programming languages and language internals. This blog post is meant to be the first in a series that walks through some fundamentals of common languages. Today’s post is about C++ templates and their semantics, and then in future posts I’ll be discussing how templates differ from the idea of generics in other languages like Java.</p>
<h2 id="templates-101">Templates 101</h2>
<p>It’s a very common problem in writing software where you want to take a set of functions or classes and generalize them to work for any input data type.</p>
<p>For example, let’s say that we want to calculate the sum of the items in a vector. We don’t care ahead of time what’s inside the vector, we just want to write the general <strong>algorithm</strong> for the sum, and then apply it to any vector.</p>
<p>In a language like Python, this is fairly trivial:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">def</span> mysum(lst):</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">    accum <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="cf">for</span> val <span class="kw">in</span> lst:</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">      accum <span class="op">+=</span> val</a></code></pre></div>
<p>Thanks to Python’s support for duck-typing, we don’t need to care about the type of data inside of <code>vec</code>, all that matters is that we can add two such items together.</p>
<p>How would this code look in a language like C++? Pretty similar, with different syntax. We need to make use of C++’s <strong><em>templates</em></strong> feature.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">T mysum(T[] items, <span class="dt">size_t</span> numItems) {</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    T accum = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="cf">for</span> (<span class="dt">size_t</span> i = <span class="dv">0</span>; i &lt; numItems; i++) {</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">        accum += items[i];</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    }</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    <span class="cf">return</span> accum;</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">}</a></code></pre></div>
<h2 id="the-first-law-of-templates-lazy-generation">The First Law of Templates: Lazy Generation</h2>
<p>These two blocks of code look similar enough if you squint at them, but there’s something very different going on under the hood: in C++, this code doesn’t exist.</p>
<blockquote>
<p><strong><em>doesn’t exist?</em></strong></p>
</blockquote>
<p>Yep, it turns out that template code is really just <strong>phantom code</strong>, and doesn’t generate any assembly on its own.</p>
<p>To see an example of this, let’s see the assembly that gets generated for the following file:</p>
<pre class="shell"><code>$ cat &lt;&lt;EOF &gt; test.cc
template&lt;typename T&gt;
T identity(T t) {
    return t;
}

int main() {
  return 0;
}
EOF
$ g++ -S test.cc
$ cat test.S

_main:                                  ## @main
  .cfi_startproc
  ... code for main() function...
  .cfi_endproc</code></pre>
<h2 id="concrete-class-generation">Concrete Class Generation</h2>
<p>Let’s see what happens when we adjust our example from before to include a call to the <code>identity</code> function:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">T identity(T t) {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="cf">return</span> t;</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="dt">int</span> main() {</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  <span class="cf">return</span> identity(<span class="dv">10</span>); <span class="co">// should return 10</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">}</a></code></pre></div>
<p>Now, let’s look at the generated assembly:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode asm"><code class="sourceCode fasm"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="fu">_main:</span>                                  ## @main</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  .cfi_startproc</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  ... <span class="bu">stack</span> setup, function argument setup ...</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  callq __Z8identityIiET_S0_</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  ... <span class="bu">stack</span> cleanup ...</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  .cfi_endproc</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  ...</a>
<a class="sourceLine" id="cb5-9" data-line-number="9"></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="fu">__Z8identityIiET_S0_:</span>                   ## @_Z8identityIiET_S0_</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">  .cfi_startproc</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  ... implementation of identity that takes an <span class="bu">int</span> <span class="bu">and</span> returns an <span class="bu">int</span> ...</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">  .cfi_endproc</a></code></pre></div>
<p>Note the name of the second function: <code>__Z8identityIiET_S0_</code>. The important part of that string of garbage characters is <code>Ii</code>, with the second <code>i</code> denoting that the function returns an int. If we add another call, and look at the generated assembly:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">T identity(T t) {</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    <span class="cf">return</span> t;</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="dt">int</span> main() {</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">  <span class="dt">double</span> d = identity(<span class="fl">10.0</span>);</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">  <span class="cf">return</span> identity(<span class="dv">10</span>); <span class="co">// should return 10</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">}</a></code></pre></div>
<pre class="assembly"><code>_main:                                  ## @main
  .cfi_startproc
  ... main includes calls to both identity functions ...
  .cfi_endproc

  .globl  __Z8identityIdET_S0_
__Z8identityIdET_S0_:                   ## @_Z8identityIdET_S0_
  .cfi_startproc
  ... implementation of double identity(double); ...
  .cfi_endproc

  .globl  __Z8identityIiET_S0_
__Z8identityIiET_S0_:                   ## @_Z8identityIiET_S0_
  .cfi_startproc
  ... implementation of int identity(int); ...
  .cfi_endproc</code></pre>
<h2 id="next-time">Next Time</h2>
<p>So this time we walked through a few example of generation of templates in C++, and the way they’re lazily generated. In the next post in the series, we’ll talk about generics in languages like Java and Scala, and eventually move on to structural subtyping like what we see in the <a href="https://golang.org">go</a> world.</p>


<hr />

<div>
    Like this post? Hate this post? <a href="https://twitter.com/intent/tweet?text=@andreweduffy+https://aduffy.io/posts/2016-10-21-inside-templates.html+">Give me your feedback!</a>
</div>

      </div>
    </div>

    
  </body>
</html>
